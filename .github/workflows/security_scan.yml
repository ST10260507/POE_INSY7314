name: DevSecOps CI Pipeline

on:
  push:
    # Trigger the pipeline whenever code is pushed to the main or master branch
    branches:
      - main
      - master
  pull_request:
    # Also run scans when a pull request is opened/updated against main
    branches:
      - main

jobs:
  # ===============================================
  # JOB 1: Software Composition Analysis (SCA) - npm audit
  # ===============================================
  dependency_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use your project's target Node version

      # 1. Scan the Backend (assuming separate package.json)
      - name: Install Backend Dependencies
        run: npm install --prefix Backend/
      - name: Run Backend npm audit
        run: npm audit --prefix Backend/ --audit-level=high

      # 2. Scan the Frontend (assuming separate package.json)
      - name: Install Frontend Dependencies
        run: npm install --prefix Frontend/  
      - name: Run Frontend npm audit
        run: npm audit --prefix Frontend/ --audit-level=high  

---

  # ===============================================
  # JOB 2: Static Analysis Security Testing (SAST)
  # Checks your code for common security bugs and uploads results.
  # ===============================================
  sast_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        
      # 1. Run Semgrep SAST tool and generate SARIF report
      - name: üîé Run Semgrep SAST Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit # Common ruleset for good coverage
          # Output the results in SARIF format for GitHub Code Scanning
          output: semgrep.sarif
          
      # 2. Upload the SARIF results to GitHub Security Tab
      - name: ‚¨ÜÔ∏è Upload SARIF to GitHub Code Scanning
        uses: github/code-scanning-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif # File generated in the previous step
          
---

  # ===============================================
  # JOB 3: Secrets Scanning (Credential Detection)
  # Checks repository history and changes for exposed secrets.
  # ===============================================
  secrets_scan:
    runs-on: ubuntu-latest
    # Recommended: You can make this job depend on the others to run in sequence
    # needs: [dependency_scan, sast_scan] 
    steps:
      - uses: actions/checkout@v4
        with:
          # CRITICAL: Fetch full history for accurate secrets detection
          fetch-depth: 0 

      - name: üîë Run GitLeaks Secrets Scan
        # This action automatically scans and fails the job if any secrets are found
        uses: zricethezav/gitleaks-action@v9
        with:
          fail: true
          verbose: true

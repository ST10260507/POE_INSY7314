name: DevSecOps CI Pipeline

on:
  push:
    # Trigger the pipeline whenever code is pushed to the main or master branch
    branches:
      - main
      - master
  pull_request:
    # Also run scans when a pull request is opened/updated against main
    branches:
      - main

jobs:
  # ===============================================
  # JOB 1: Software Composition Analysis (SCA) - npm audit
  # [Covers: check vulnerabilities in dependencies]
  # ===============================================
  dependency_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. Scan the Backend
      - name: Install Backend Dependencies
        run: npm install --prefix Backend/
      - name: Run Backend npm audit
        run: npm audit --prefix Backend/ --audit-level=high

      # 2. Scan the Frontend
      - name: Install Frontend Dependencies
        run: npm install --prefix Frontend/  
      - name: Run Frontend npm audit
        run: npm audit --prefix Frontend/ --audit-level=high  

---

  # ===============================================
  # JOB 2: SonarQube Scan (SAST & Code Smells)
  # [Fulfills: run a SonarQube scan]
  # Note: Requires SONAR_TOKEN secret and SonarCloud project setup.
  # ===============================================
  sonarqube_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # REQUIRED: Fetch full history for proper branch linking
          fetch-depth: 0 
          
      - name: ðŸ”Ž Execute SonarCloud Scan
        # Use the official action for a robust and simplified setup
        uses: SonarSource/sonarcloud-github-action@master
        env:
          # Your token stored in GitHub Secrets
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} 
        with:
          # Replace 'YOUR_ORGANIZATION_KEY' and 'YOUR_PROJECT_KEY' with your actual keys
          args: >
            -Dsonar.organization=Ankriya 
            -Dsonar.projectKey=ST10260507_POE_INSY7314

---

  # ===============================================
  # JOB 3: Secrets Scanning (Credential Detection)
  # [Covers: Additional Research/Exceptional Implementation]
  # ===============================================
  secrets_scan:
    runs-on: ubuntu-latest
    # Run in parallel with other security scans
    steps:
      - uses: actions/checkout@v4
        with:
          # CRITICAL: Fetch full history for accurate secrets detection
          fetch-depth: 0 

      - name: ðŸ”‘ Run GitLeaks Secrets Scan
        # This action automatically scans and fails the job if any secrets are found
        uses: zricethezav/gitleaks-action@v9
        with:
          fail: true
          verbose: true

---

  # ===============================================
  # JOB 4: API and Unit Testing
  # [Fulfills: API testing used to test endpoints]
  # ===============================================
  api_testing:
    runs-on: ubuntu-latest
    # Recommended to run only if all security scans pass
    needs: [dependency_scan, sonarqube_scan, secrets_scan] 
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: Install All Dependencies
        # Install all necessary dependencies for tests to run
        run: |
          npm install --prefix Backend/
          npm install --prefix Frontend/ 

      - name: ðŸš€ Run Backend and API Tests
        # This command runs all tests defined in the package.json "test" script
        run: npm test --prefix Backend/
